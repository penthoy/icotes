<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Streaming Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #output { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll; white-space: pre-wrap; }
        #controls { margin-bottom: 20px; }
        .chunk { background: #f0f0f0; margin: 2px 0; padding: 2px; border-left: 3px solid #007acc; }
        .timestamp { color: #666; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>ICUI Custom Agent WebSocket Streaming Test</h1>
    <div id="controls">
        <button onclick="testStreaming()">Test OpenAIDemoAgent Streaming</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    <div id="output"></div>

    <script>
        function log(message, isChunk = false) {
            const output = document.getElementById('output');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const div = document.createElement('div');
            div.className = isChunk ? 'chunk' : '';
            div.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function testStreaming() {
            log('🚀 Starting WebSocket streaming test...');
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/custom-agents/OpenAIDemoAgent/stream`;
            
            log(`📡 Connecting to: ${wsUrl}`);
            
            const ws = new WebSocket(wsUrl);
            let chunkCount = 0;
            let startTime = null;
            let lastChunkTime = null;
            
            ws.onopen = () => {
                log('✅ WebSocket connected');
                startTime = Date.now();
                lastChunkTime = startTime;
                
                // Send test message
                const message = {
                    type: "message",
                    content: "Count from 1 to 3 and explain each number briefly",
                    history: []
                };
                
                log(`📤 Sending message: ${JSON.stringify(message)}`);
                ws.send(JSON.stringify(message));
            };
            
            ws.onmessage = (event) => {
                const now = Date.now();
                const data = JSON.parse(event.data);
                const elapsed = startTime ? ((now - startTime) / 1000).toFixed(2) : '?';
                const timeSinceLastChunk = lastChunkTime ? ((now - lastChunkTime) / 1000).toFixed(3) : '?';
                
                if (data.type === "stream_chunk") {
                    chunkCount++;
                    log(`📝 [${elapsed}s] (+${timeSinceLastChunk}s) Chunk ${chunkCount}: "${data.content}"`, true);
                    lastChunkTime = now;
                } else if (data.type === "stream_complete") {
                    log(`🏁 [${elapsed}s] Streaming complete (${chunkCount} chunks total)`);
                    ws.close();
                } else if (data.type === "error") {
                    log(`❌ Error: ${data.message}`);
                    ws.close();
                } else {
                    log(`📦 Other message: ${JSON.stringify(data)}`);
                }
            };
            
            ws.onerror = (error) => {
                log(`❌ WebSocket error: ${error}`);
            };
            
            ws.onclose = (event) => {
                log(`🔌 WebSocket closed (code: ${event.code}, reason: ${event.reason})`);
            };
        }
    </script>
</body>
</html>
